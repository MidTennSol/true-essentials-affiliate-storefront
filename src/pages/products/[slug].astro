---
import { getProductBySlug, getAllProducts } from '../../lib/airtable.js';
import type { AirtableProduct } from '../../lib/airtable.js';
import Header from '../../components/Header.astro';
import { generateImageUrlCandidates } from '../../lib/amazon-scraper.ts';

export async function getStaticPaths() {
  try {
    const products = await getAllProducts();
    return products.map((product) => ({
      params: { slug: product.fields.Slug },
      props: { product },
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

const { slug } = Astro.params;
let { product } = Astro.props as { product: AirtableProduct };

// Fallback: try to fetch product if not provided via static generation
if (!product && slug) {
  try {
    const fetchedProduct = await getProductBySlug(slug);
    if (fetchedProduct) {
      product = fetchedProduct;
    }
  } catch (error) {
    console.error('Error fetching product:', error);
  }
}

// Handle 404 case
if (!product) {
  return Astro.redirect('/404');
}

const pageTitle = `${product.fields.Title} - True Essentials`;
const pageDescription = product.fields.Description.substring(0, 160) + '...';

// Generate fallback image URLs if the main image URL doesn't work
const extractASIN = (url: string) => {
  const match = url.match(/\/dp\/([A-Z0-9]{10})/);
  return match ? match[1] : null;
};

const asin = extractASIN(product.fields['Affiliate URL'] || '');
const fallbackImageUrls = asin ? generateImageUrlCandidates(asin) : [];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{pageTitle}</title>
  <meta name="description" content={pageDescription}>
  
  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="product">
  <meta property="og:title" content={product.fields.Title}>
  <meta property="og:description" content={pageDescription}>
  <meta property="og:image" content={product.fields['Image URL']}>
  <meta property="og:url" content={`https://yoursite.com/products/${product.fields.Slug}`}>
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={product.fields.Title}>
  <meta name="twitter:description" content={pageDescription}>
  <meta name="twitter:image" content={product.fields['Image URL']}>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    main {
      margin-top: 2rem;
    }

    .breadcrumb {
      margin-bottom: 2rem;
      font-size: 0.9rem;
      color: #64748b;
    }

    .breadcrumb a {
      color: #2563eb;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .breadcrumb span {
      margin: 0 0.5rem;
    }

    .product-detail {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 3rem;
    }

    .product-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      padding: 3rem;
    }

    .product-image-section {
      position: relative;
    }

    .product-image {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 8px;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }

    .product-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .product-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 1rem;
      line-height: 1.3;
    }

    .product-description {
      color: #475569;
      font-size: 1.1rem;
      line-height: 1.7;
      margin-bottom: 2rem;
      white-space: pre-line;
    }

    .product-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-block;
      flex: 1;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 2px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    .product-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #e2e8f0;
    }

    .meta-item {
      text-align: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
    }

    .meta-label {
      font-size: 0.8rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .meta-value {
      font-weight: 600;
      color: #1e293b;
    }

    .trust-badges {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 2rem 0;
      padding: 1.5rem;
      background: #f8fafc;
      border-radius: 8px;
    }

    .trust-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #22c55e;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .related-products {
      margin-top: 4rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    footer {
      background: white;
      border-top: 1px solid #e2e8f0;
      padding: 2rem 0;
      margin-top: 4rem;
      text-align: center;
      color: #64748b;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      nav a {
        margin: 0 1rem;
      }

      .product-layout {
        grid-template-columns: 1fr;
        gap: 2rem;
        padding: 2rem;
      }

      .product-title {
        font-size: 1.5rem;
      }

      .product-description {
        font-size: 1rem;
      }

      .product-actions {
        flex-direction: column;
      }

      .trust-badges {
        flex-direction: column;
        gap: 1rem;
      }

      .product-meta {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <Header />
  
  <main class="container">
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>/</span>
      <a href="/products">Products</a>
      <span>/</span>
      <span>{product.fields.Title}</span>
    </div>

    <div class="product-detail">
      <div class="product-layout">
        <div class="product-image-section">
          <img 
            src={product.fields['Image URL'] || (fallbackImageUrls[0] || 'https://via.placeholder.com/400x400/e2e8f0/64748b?text=üç≥+Kitchen+Item')}
            alt={product.fields.Title}
            class="product-image"
            loading="eager"
            onerror="this.src='https://via.placeholder.com/400x400/e2e8f0/64748b?text=üç≥+Kitchen+Item'; this.onerror=null;"
          />
        </div>

        <div class="product-info">
          <h1 class="product-title">{product.fields.Title}</h1>
          <div class="product-description">{product.fields.Description}</div>

          <div class="product-actions">
            <a 
              href={product.fields['Affiliate URL']}
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-primary"
            >
              üõí Buy on Amazon
            </a>
            <a 
              href="/products"
              class="btn btn-secondary"
            >
              ‚Üê Back to Products
            </a>
          </div>

          <div class="trust-badges">
            <div class="trust-badge">
              <span>‚úÖ</span>
              <span>Verified Product</span>
            </div>
            <div class="trust-badge">
              <span>üöö</span>
              <span>Fast Shipping</span>
            </div>
            <div class="trust-badge">
              <span>üîí</span>
              <span>Secure Purchase</span>
            </div>
          </div>

          <div class="product-meta">
            <div class="meta-item">
              <div class="meta-label">Product ID</div>
              <div class="meta-value">{product.id}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Added</div>
              <div class="meta-value">{new Date(product.fields['Created At']).toLocaleDateString()}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Category</div>
              <div class="meta-value">Essential Items</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="related-products">
      <h2 class="section-title">More Great Products</h2>
      <div style="text-align: center; padding: 2rem; color: #64748b;">
        <a href="/products" class="btn btn-primary">View All Products</a>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 True Essentials. All rights reserved.</p>
    </div>
  </footer>

  <!-- JSON-LD structured data for SEO -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "{product.fields.Title}",
      "description": "{product.fields.Description}",
      "image": "{product.fields['Image URL']}",
      "url": "https://yoursite.com/products/{product.fields.Slug}",
      "brand": {
        "@type": "Brand",
        "name": "True Essentials"
      },
      "offers": {
        "@type": "Offer",
        "url": "{product.fields['Affiliate URL']}",
        "availability": "https://schema.org/InStock"
      }
    }
  </script>
</body>
</html> 