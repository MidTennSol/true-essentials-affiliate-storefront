---
import Header from '../../components/Header.astro';

// Check authentication
const isAuthenticated = Astro.cookies.get('admin_auth')?.value === 'authenticated';

if (!isAuthenticated) {
  return Astro.redirect('/admin');
}

let results = {
  hasApiKey: false,
  hasBaseId: false,
  canConnect: false,
  canCreate: false,
  error: null as string | null,
  testProductId: null as string | null
};

try {
  // Check environment variables
  results.hasApiKey = !!import.meta.env.AIRTABLE_API_KEY;
  results.hasBaseId = !!import.meta.env.AIRTABLE_BASE_ID;
  
  if (results.hasApiKey && results.hasBaseId) {
    // Test connection
    const { testConnection, createProduct } = await import('../../lib/airtable');
    
    results.canConnect = await testConnection();
    
    if (results.canConnect) {
      // Test creating a product
      try {
        const testProduct = await createProduct({
          title: 'TEST - Safe to Delete',
          description: 'Test product for diagnostics',
          imageUrl: 'https://via.placeholder.com/300x300?text=TEST',
          affiliateUrl: 'https://amazon.com/test'
        });
        
        results.canCreate = true;
        results.testProductId = testProduct.id;
      } catch (createError) {
        results.error = `Create failed: ${String(createError)}`;
      }
    } else {
      results.error = 'Connection test failed';
    }
  } else {
    results.error = 'Missing API key or Base ID';
  }
} catch (error) {
  results.error = `System error: ${String(error)}`;
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Airtable Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeaa7;
    }
    .back-btn {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <Header />
  
  <div class="container">
    <a href="/admin" class="back-btn">‚Üê Back to Admin</a>
    
    <h1>üîß Simple Airtable Test</h1>
    
    <div class={`result ${results.hasApiKey ? 'success' : 'error'}`}>
      <strong>API Key:</strong> {results.hasApiKey ? '‚úÖ Found' : '‚ùå Missing'}
    </div>
    
    <div class={`result ${results.hasBaseId ? 'success' : 'error'}`}>
      <strong>Base ID:</strong> {results.hasBaseId ? '‚úÖ Found' : '‚ùå Missing'}
    </div>
    
    <div class={`result ${results.canConnect ? 'success' : 'error'}`}>
      <strong>Connection:</strong> {results.canConnect ? '‚úÖ Success' : '‚ùå Failed'}
    </div>
    
    <div class={`result ${results.canCreate ? 'success' : 'error'}`}>
      <strong>Create Test:</strong> {results.canCreate ? '‚úÖ Success' : '‚ùå Failed'}
    </div>
    
    {results.testProductId && (
      <div class="result success">
        <strong>Test Product Created:</strong> ID {results.testProductId}
        <br><small>You can safely delete this from your Airtable</small>
      </div>
    )}
    
    {results.error && (
      <div class="result error">
        <strong>Error Details:</strong><br>
        {results.error}
      </div>
    )}
    
    <h2>What This Means:</h2>
    <ul>
      <li><strong>If all green ‚úÖ:</strong> Airtable is working perfectly</li>
      <li><strong>If Create Test fails ‚ùå:</strong> There's a permission or field issue</li>
      <li><strong>If Connection fails ‚ùå:</strong> Wrong API key or Base ID</li>
    </ul>
  </div>
</body>
</html> 