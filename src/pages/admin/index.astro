---
// @ts-nocheck
// Admin dashboard - password protected
import { getAllProducts } from '../../lib/airtable.js';

// Get environment variables
const adminPassword = import.meta.env.ADMIN_PASSWORD || 'letmein';

// Initialize variables
let errorMessage = null;

// Handle POST request for login
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const password = formData.get('password');
  
  if (password === adminPassword) {
    // Set session cookie
    Astro.cookies.set('admin_auth', 'authenticated', {
      httpOnly: true,
      secure: false,
      sameSite: 'strict',
      maxAge: 60 * 60 * 24, // 24 hours
      path: '/'
    });
    
    // Redirect to prevent form resubmission
    return Astro.redirect('/admin');
  } else {
    errorMessage = 'Invalid password. Please try again.';
  }
}

// Check if user is already authenticated
const isAuthenticated = Astro.cookies.get('admin_auth')?.value === 'authenticated';

// If authenticated, get products for dashboard stats
let products = [];
let errorLoadingProducts = null;
let totalProducts = 0;
let productsWithImages = 0;
let productsWithAffiliateLinks = 0;

if (isAuthenticated) {
  try {
    products = await getAllProducts();
    totalProducts = products.length;
    
    // Count products with images and affiliate links
    for (const product of products) {
      if (product.fields && product.fields['Image URL']) {
        productsWithImages++;
      }
      if (product.fields && product.fields['Affiliate URL']) {
        productsWithAffiliateLinks++;
      }
    }
  } catch (error) {
    errorLoadingProducts = String(error);
  }
}

// Handle logout
if (Astro.url.searchParams.get('logout') === 'true') {
  Astro.cookies.delete('admin_auth');
  return Astro.redirect('/admin');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - True Essentials</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .btn {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-right: 10px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .nav-buttons {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    {!isAuthenticated ? (
      <div>
        <h1>üîê Admin Login</h1>
        <p>Enter your password to access the admin dashboard</p>
        
        {errorMessage && (
          <div class="error">{errorMessage}</div>
        )}
        
        <form method="POST">
          <div class="form-group">
            <label for="password">Password:</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              placeholder="Enter admin password"
            />
          </div>
          <button type="submit" class="btn">Login</button>
        </form>
      </div>
    ) : (
      <div>
        <div class="header">
          <h1>üõ†Ô∏è Admin Dashboard</h1>
          <a href="/admin?logout=true" class="btn">Logout</a>
        </div>

        <h2>Product Management</h2>
        <div class="nav-buttons">
          <a href="/admin/add-product" class="btn">Add Single Product</a>
          <a href="/admin/bulk-add" class="btn">Bulk Add Products</a>
          <a href="/products" class="btn">View Storefront</a>
        </div>

        <p>Welcome to the admin dashboard! Use the buttons above to manage your product catalog.</p>
      </div>
    )}
  </div>
</body>
</html> 